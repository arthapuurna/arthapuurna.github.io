<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Benakasemmemii → IPA + TTS</title>
<style>
body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:#fbfdff; color:#0f172a; margin:0; padding:28px; display:flex; justify-content:center;}
.wrap{width:100%; max-width:980px;}
h1{font-size:1.25rem;}
p.lead{margin:8px 0 18px; color:#6b7280; font-size:0.95rem;}
.card{background:#fff; border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(15,23,42,0.06); margin-top:18px;}
textarea{width:100%; min-height:120px; font-size:1.05rem; padding:12px; border:1px solid #e6eefc; border-radius:8px; resize:vertical; box-sizing:border-box;}
.row{display:flex; gap:12px; align-items:center; margin-top:12px; flex-wrap:wrap;}
button{background:#2f6fed; color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600;}
button.ghost{background:transparent; color:#2f6fed; border:1px solid rgba(47,111,237,0.12);}
#output{min-height:80px; padding:12px; background:#f8fafc; border-radius:8px; font-family: "Noto Sans", system-ui, "Segoe UI", Roboto, Arial; white-space:pre-wrap; margin-top:12px; border:1px solid #eef2ff;}
label{font-size:0.9rem; color:#6b7280;}
select,input[type=range]{padding:6px 8px; border-radius:8px; }
.controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
.small{font-size:0.85rem; color:#6b7280;}
footer{margin-top:14px; font-size:0.82rem; color:#6b7280;}
.kbd{font-family:monospace; background:#f1f5f9; padding:2px 6px; border-radius:6px; font-size:0.85rem;}
</style>
</head>
<body>
<div class="wrap">
  <h1>Benakasemmemii → IPA + TTS</h1>
  <p class="lead">Paste Benakasemmemii text, press <span class="kbd">Convert</span> to get IPA with stress rules. Use <span class="kbd">Play</span> to hear an approximate pronunciation.</p>

  <div class="card">
    <label for="input">Benakasemmemii text</label>
    <textarea id="input" placeholder="Type or paste Benakasemmemii here..."></textarea>

    <div class="row">
      <div class="controls">
        <button id="convertBtn">Convert to IPA</button>
        <button id="copyIpa" class="ghost">Copy IPA</button>
        <button id="clearBtn" class="ghost">Clear</button>
      </div>

      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <label class="small">Voice</label>
        <select id="voiceSelect" aria-label="Select voice"></select>
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <label class="small">Rate</label>
      <input id="rate" type="range" min="0.6" max="1.6" step="0.05" value="0.95">
      <label class="small">Pitch</label>
      <input id="pitch" type="range" min="0.6" max="1.6" step="0.05" value="1.0">
      <button id="speakBtn" style="margin-left:auto">🔊 Play</button>
    </div>

    <div id="output" aria-live="polite"></div>

    <div class="row" style="margin-top:10px;">
      <div style="flex:1">
        <label class="small">Approx. TTS text (editable)</label>
        <textarea id="ttsText" rows="3" placeholder="Editable phonetic text for the speech engine..."></textarea>
      </div>
    </div>

    <footer>
      <div>Note: browser TTS reads the editable ASCII phonetic text; it cannot reliably speak raw IPA.</div>
    </footer>
  </div>
</div>

<script>
/* =========================
   Mapping and IPA conversion
========================= */
const mappingOrdered = [
["jny","d͡ʑɲ"],["ong","õ"],
["aa","aː"],["bh","bʱ"],["ch","t͡ɕʰ"],["dh","dʱ"],["ei","eː"],["gh","gʱ"],
["ii","iː"],["jh","d͡ʑʱ"],["kh","kʰ"],["ou","oː"],["ph","pʰ"],["rr","r"],
["sh","ɕ"],["th","tʰ"],["uu","uː"],
["ai","ai̯"],["au","au̯"],["eu","eu̯"],["oi","oi̯"],["ui","ui̯"],
["ng","ŋg"],["nk","ŋk"],
["a","a"],["b","b"],["c","t͡ɕ"],["d","d"],["e","e"],["f","f"],["g","g"],
["h","h"],["i","i"],["j","d͡ʑ"],["k","k"],["l","l"],["m","m"],["n","n"],
["o","o"],["p","p"],["r","ɾ"],["s","s"],["t","t"],["u","u"],["w","ʋ"],
["y","j"],["z","z"],["q","k"],["v","ʋ"],["x","ks"]
];
const vowelPatterns = ["aa","ii","uu","ei","ou","ai","au","eu","oi","ui","a","e","i","o","u"];

function escapeRegExp(string){ return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function orthographicToIPA(word){
  let wasHyphenOng=false;
  if(word.includes("-")&&word.endsWith("ong")){ wasHyphenOng=true; word=word.slice(0,-3)+"⟨ONG⟩"; }
  let s = word.toLowerCase();
  for(const [ort, ipa] of mappingOrdered){
    const re = new RegExp(escapeRegExp(ort),"g");
    s = s.replace(re, ipa);
  }
  if(wasHyphenOng){ s = s.replace("⟨ONG⟩","õ"); }
  return s;
}
function syllabifyOrth(word){
  const regexParts = vowelPatterns.map(v=>escapeRegExp(v)).join("|");
  const re = new RegExp(`[^aeiou]*(${regexParts})(?:[^aeiou]*)`, "gi");
  let out=[]; let m;
  while((m=re.exec(word))!==null){ out.push(m[0]); }
  if(out.length===0) out=[word];
  return out;
}
function isHeavySyl(syl){
  const longVowels = ["aa","ii","uu","ei","ou","ai","au","eu","oi","ui"];
  for(const lv of longVowels) if(syl.toLowerCase().includes(lv)) return true;
  const m = syl.match(/[aeiou]([^aeiou]{2,})$/i);
  if(m) return true;
  return false;
}
function applyStressToWordOrth(wordOrthSylls){
  const n = wordOrthSylls.length;
  if(n===1){ wordOrthSylls[0]="ˈ"+wordOrthSylls[0]; return wordOrthSylls; }
  if(n===2){ wordOrthSylls[0]="ˈ"+wordOrthSylls[0]; return wordOrthSylls; }
  const antepenultIdx = n-3;
  const penultIdx = n-2;
  const penult = wordOrthSylls[penultIdx];
  const usePenult = isHeavySyl(penult);
  if(usePenult){ wordOrthSylls[penultIdx]="ˈ"+wordOrthSylls[penultIdx]; } 
  else { wordOrthSylls[antepenultIdx]="ˈ"+wordOrthSylls[antepenultIdx]; }
  return wordOrthSylls;
}
function wordOrthToIPAWithStress(word){
  const orthSyls = syllabifyOrth(word);
  const stressedOrth = applyStressToWordOrth(orthSyls.slice());
  const ipaSyls = stressedOrth.map(syl=>{
    const stressed=syl.startsWith("ˈ"); const clean=stressed?syl.slice(1):syl;
    const ipa = orthographicToIPA(clean);
    return (stressed?"ˈ":"")+ipa;
  });
  return ipaSyls.join("");
}

/* =========================
   TTS with last word high pitch in questions
========================= */
function speakWithLastWordHighPitch(text, pitch=1.3, normalPitch=1.0, rate=0.95) {
    const sentences = text.match(/[^.!?]+[.!?]?/g) || [];
    sentences.for