<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Benakasemmemii → IPA + TTS</title>
<style>
body { font-family: Arial, sans-serif; background: #f8fafc; color: #0f172a; margin:0; padding:20px; display:flex; justify-content:center;}
.wrap { width:100%; max-width:800px; }
h1 { font-size:1.3rem; }
textarea { width:100%; min-height:120px; font-size:1rem; padding:10px; border-radius:8px; border:1px solid #ccc; resize:vertical; margin-top:8px; }
button { padding:8px 12px; margin:4px; border-radius:6px; cursor:pointer; border:none; background:#2f6fed; color:white; font-weight:600; }
button.ghost { background:transparent; border:1px solid #2f6fed; color:#2f6fed; }
#output { min-height:80px; padding:10px; background:#fff; border-radius:8px; border:1px solid #ccc; margin-top:8px; white-space:pre-wrap; }
.row { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; align-items:center; }
label.small { font-size:0.85rem; color:#555; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Benakasemmemii → IPA + TTS</h1>

  <label for="input">Benakasemmemii text</label>
  <textarea id="input" placeholder="Type or paste Benakasemmemii here..."></textarea>

  <div class="row">
    <button id="convertBtn">Convert to IPA</button>
    <button id="copyIpa" class="ghost">Copy IPA</button>
    <button id="clearBtn" class="ghost">Clear</button>
  </div>

  <label class="small">IPA Output</label>
  <div id="output"></div>

  <label class="small">Editable TTS text</label>
  <textarea id="ttsText" rows="3" placeholder="Editable text for speech synthesis"></textarea>
  <div class="row">
    <label class="small">Rate</label>
    <input id="rate" type="range" min="0.6" max="1.6" step="0.05" value="0.95">
    <label class="small">Pitch</label>
    <input id="pitch" type="range" min="0.6" max="1.6" step="0.05" value="1.0">
    <button id="speakBtn">🔊 Play</button>
  </div>
</div>

<script>
// ==================== Mapping & IPA ====================
const mappingOrdered = [
["jny","dʑɲ"],["ong","õ"],
["aa","aː"],["bh","bʱ"],["ch","tɕ"],["dh","dʱ"],["ei","eː"],["gh","gʱ"],
["ii","iː"],["jh","dʑʱ"],["kh","kʰ"],["ou","oː"],["ph","pʰ"],["rr","r"],
["sh","ɕ"],["th","tʰ"],["uu","uː"],
["ai","ai̯"],["au","au̯"],["eu","eu̯"],["oi","oi̯"],["ui","ui̯"],
["ng","ŋg"],["nk","ŋk"],
["a","a"],["b","b"],["c","tɕ"],["d","d"],["e","e"],["f","f"],["g","g"],
["h","h"],["i","i"],["j","dʑ"],["k","k"],["l","l"],["m","m"],["n","n"],
["o","o"],["p","p"],["r","ɾ"],["s","s"],["t","t"],["u","u"],["w","ʋ"],
["y","j"],["z","z"],["q","k"],["v","ʋ"],["x","ks"]
];
const vowelPatterns = ["aa","ii","uu","ei","ou","ai","au","eu","oi","ui","a","e","i","o","u"];

function escapeRegExp(string){ return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function orthographicToIPA(word){
  let wasHyphenOng=false;
  if(word.includes("-")&&word.endsWith("ong")){ wasHyphenOng=true; word=word.slice(0,-3)+"⟨ONG⟩"; }
  let s = word.toLowerCase();
  for(const [ort, ipa] of mappingOrdered){
    const re = new RegExp(escapeRegExp(ort),"g");
    s = s.replace(re, ipa);
  }
  if(wasHyphenOng){ s = s.replace("⟨ONG⟩","õ"); }
  return s;
}
function syllabifyOrth(word){
  const regexParts = vowelPatterns.map(v=>escapeRegExp(v)).join("|");
  const re = new RegExp(`[^aeiou]*(${regexParts})(?:[^aeiou]*)`, "gi");
  let out=[]; let m;
  while((m=re.exec(word))!==null){ out.push(m[0]); }
  if(out.length===0) out=[word];
  return out;
}
function isHeavySyl(syl){
  const longVowels = ["aa","ii","uu","ei","ou","ai","au","eu","oi","ui"];
  for(const lv of longVowels) if(syl.toLowerCase().includes(lv)) return true;
  const m = syl.match(/[aeiou]([^aeiou]{2,})$/i);
  if(m) return true;
  return false;
}
function applyStressToWordOrth(wordOrthSylls){
  const n = wordOrthSylls.length;
  if(n===1){ wordOrthSylls[0]="ˈ"+wordOrthSylls[0]; return wordOrthSylls; }
  if(n===2){ wordOrthSylls[0]="ˈ"+wordOrthSylls[0]; return wordOrthSylls; }
  const antepenultIdx = n-3;
  const penultIdx = n-2;
  const penult = wordOrthSylls[penultIdx];
  const usePenult = isHeavySyl(penult);
  if(usePenult){ wordOrthSylls[penultIdx]="ˈ"+wordOrthSylls[penultIdx]; } 
  else { wordOrthSylls[antepenultIdx]="ˈ"+wordOrthSylls[antepenultIdx]; }
  return wordOrthSylls;
}
function wordOrthToIPAWithStress(word){
  const orthSyls = syllabifyOrth(word);
  const stressedOrth = applyStressToWordOrth(orthSyls.slice());
  const ipaSyls = stressedOrth.map(syl=>{
    const stressed=syl.startsWith("ˈ"); const clean=stressed?syl.slice(1):syl;
    const ipa = orthographicToIPA(clean);
    return (stressed?"ˈ":"")+ipa;
  });
  return ipaSyls.join("");
}

// ==================== TTS-friendly transliteration ====================
function benakasemmemiiToTTS(text){
    let t = text;
    t = t.replace(/aa/g, "aa");
    t = t.replace(/ii/g, "ii");
    t = t.replace(/uu/g, "uu");
    t = t.replace(/ei/g, "ei");
    t = t.replace(/ou/g, "ou");
    t = t.replace(/ai/g, "ai");
    t = t.replace(/au/g, "au");
    t = t.replace(/eu/g, "eu");
    t = t.replace(/oi/g, "oi");
    t = t.replace(/ui/g, "ui");
    t = t.replace(/-ong\b/g, "-ong");
    t = t.replace(/\b(\w+?)(re|ge|we|ye)\b/gi, "$1-$2");
    t = t.replace(/--+/g,"-");
    t = t.replace(/- /g,"-");
    return t;
}

// ==================== TTS ====================
function speakWithLastWordHighPitch(text, pitch=1.3, normalPitch=1.0, rate=0.95){
    if(!("speechSynthesis" in window)){
        alert("TTS not supported in this browser!");
        return;
    }
    const sentences = text.match(/[^.!?]+[.!?]?/g)||[];
    sentences.forEach(sentence=>{
        sentence = sentence.trim();
        if(sentence.endsWith("?")){
            const words = sentence.split(/\s+/);
            const lastWord = words.pop();
            const startSentence = words.join(" ");
            if(startSentence.length>0){
                const u1 = new SpeechSynthesisUtterance(startSentence+" ");
                u1.pitch = normalPitch; u1.rate=rate;
                speechSynthesis.speak(u1);
            }
            const u2 = new SpeechSynthesisUtterance(lastWord);
            u2.pitch = pitch; u2.rate=rate;
            speechSynthesis.speak(u2);
        } else {
            const u = new SpeechSynthesisUtterance(sentence);
            u.pitch=normalPitch; u.rate=rate;
            speechSynthesis.speak(u);
        }
    });
}

// ==================== DOM bindings ====================
document.addEventListener("DOMContentLoaded", function(){
    const input = document.getElementById("input");
    const output = document.getElementById("output");
    const ttsText = document.getElementById("ttsText");
    const convertBtn = document.getElementById("convertBtn");
    const copyBtn = document.getElementById("copyIpa");
    const clearBtn = document.getElementById("clearBtn");
    const speakBtn = document.getElementById("speakBtn");
    const rateInput = document.getElementById("rate");
    const pitchInput = document.getElementById("pitch");

    convertBtn.addEventListener("click",()=>{
        const words = input.value.split(/\s+/);
        const ipaWords = words.map(w=>wordOrthToIPAWithStress(w));
        const ipaResult = ipaWords.join(" ");
        output.textContent = ipaResult;
        ttsText.value = benakasemmemiiToTTS(input.value);
    });

    copyBtn.addEventListener("click",()=>{
        navigator.clipboard.writeText(output.textContent);
        alert("IPA copied!");
    });

    clearBtn.addEventListener("click",()=>{
        input.value=""; output.textContent=""; ttsText.value="";
    });

    speakBtn.addEventListener("click", ()=>{
        const text = ttsText.value.trim();
        if(text.length>0){
            const rate = parseFloat(rateInput.value);
            const pitch = parseFloat(pitchInput.value);
            speakWithLastWordHighPitch(text, pitch, 1.0, rate);
        }
    });
});
</script>
</body>
</html>
